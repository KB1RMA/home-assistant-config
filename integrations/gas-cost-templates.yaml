# Gas Cost Calculation Template Sensors
# These sensors automatically calculate gas costs using rates from National Grid multiscrape sensors
# Falls back to manual input_number helpers if website scraping fails
# Provides real-time cost tracking for Home Assistant Energy Dashboard

- sensor:
    # Cumulative gas cost sensor for energy dashboard
    - name: "Gas Total Cost"
      unique_id: gas_total_cost
      unit_of_measurement: "USD"
      device_class: monetary
      state_class: total
      state: >
        {% set current_total = states('sensor.gas_meter_consumption_15694770') | float(0) %}
        
        {# Get rates from multiscrape sensors with input_number fallbacks #}
        {% set delivery_rate = states('sensor.national_grid_gas_delivery_rate') | float(states('input_number.gas_delivery_rate') | float(0.6234)) %}
        {% set supply_rate = states('sensor.national_grid_gas_supply_rate') | float(states('input_number.gas_supply_rate') | float(0.7892)) %}
        
        {# Convert ft³ to CCF (100 cubic feet) and calculate total cost #}
        {% set total_ccf = current_total / 100 %}
        {% set total_usage_cost = total_ccf * (delivery_rate + supply_rate) %}
        
        {{ total_usage_cost | round(2) }}
      attributes:
        total_consumption_ft3: >
          {{ states('sensor.gas_meter_consumption_15694770') | float(0) }}
        total_consumption_ccf: >
          {{ (states('sensor.gas_meter_consumption_15694770') | float(0) / 100) | round(2) }}
        delivery_rate_per_ccf: >
          {{ states('sensor.national_grid_gas_delivery_rate') | float(states('input_number.gas_delivery_rate') | float(0.6234)) }}
        supply_rate_per_ccf: >
          {{ states('sensor.national_grid_gas_supply_rate') | float(states('input_number.gas_supply_rate') | float(0.7892)) }}
        combined_rate_per_ccf: >
          {% set delivery_rate = states('sensor.national_grid_gas_delivery_rate') | float(states('input_number.gas_delivery_rate') | float(0.6234)) %}
          {% set supply_rate = states('sensor.national_grid_gas_supply_rate') | float(states('input_number.gas_supply_rate') | float(0.7892)) %}
          {{ (delivery_rate + supply_rate) | round(4) }}
        note: >
          {{ "This sensor tracks cumulative usage-based costs only (excludes monthly customer charges)" }}

    # Calculate estimated monthly gas cost using input_number rates
    - name: "Estimated Monthly Gas Cost"
      unique_id: estimated_monthly_gas_cost
      unit_of_measurement: "USD"
      device_class: monetary
      state_class: total
      state: >
        {% set consumption = states('sensor.gas_meter_consumption_15694770') | float(0) %}
        {% set last_month_consumption = state_attr('sensor.gas_utility', 'last_period') | float(0) %}
        
        {# Get rates from multiscrape sensors with input_number fallbacks #}
        {% set delivery_rate = states('sensor.national_grid_gas_delivery_rate') | float(states('input_number.gas_delivery_rate') | float(0.6234)) %}
        {% set supply_rate = states('sensor.national_grid_gas_supply_rate') | float(states('input_number.gas_supply_rate') | float(0.7892)) %}
        {% set customer_charge = states('sensor.national_grid_gas_customer_charge') | float(states('input_number.gas_customer_charge') | float(14.95)) %}
        
        {# Convert ft³ to CCF (100 cubic feet) #}
        {% set monthly_ccf = last_month_consumption / 100 %}
        
        {% set delivery_cost = monthly_ccf * delivery_rate %}
        {% set supply_cost = monthly_ccf * supply_rate %}
        {% set total_cost = delivery_cost + supply_cost + customer_charge %}
        
        {{ total_cost | round(2) }}
      attributes:
        last_month_consumption_ft3: >
          {{ state_attr('sensor.gas_utility', 'last_period') | float(0) }}
        last_month_consumption_ccf: >
          {{ (state_attr('sensor.gas_utility', 'last_period') | float(0) / 100) | round(2) }}
        estimated_delivery_cost: >
          {% set last_month = state_attr('sensor.gas_utility', 'last_period') | float(0) %}
          {% set monthly_ccf = last_month / 100 %}
          {% set delivery_rate = states('sensor.national_grid_gas_delivery_rate') | float(states('input_number.gas_delivery_rate') | float(0.6234)) %}
          {{ (monthly_ccf * delivery_rate) | round(2) }}
        estimated_supply_cost: >
          {% set last_month = state_attr('sensor.gas_utility', 'last_period') | float(0) %}
          {% set monthly_ccf = last_month / 100 %}
          {% set supply_rate = states('sensor.national_grid_gas_supply_rate') | float(states('input_number.gas_supply_rate') | float(0.7892)) %}
          {{ (monthly_ccf * supply_rate) | round(2) }}
        customer_charge: >
          {{ states('sensor.national_grid_gas_customer_charge') | float(states('input_number.gas_customer_charge') | float(14.95)) }}
        delivery_rate_per_ccf: >
          {{ states('sensor.national_grid_gas_delivery_rate') | float(states('input_number.gas_delivery_rate') | float(0.6234)) }}
        supply_rate_per_ccf: >
          {{ states('sensor.national_grid_gas_supply_rate') | float(states('input_number.gas_supply_rate') | float(0.7892)) }}
        rate_source: >
          {% if states('sensor.national_grid_gas_delivery_rate') != 'unknown' and states('sensor.national_grid_gas_delivery_rate') != 'unavailable' %}
            {{ "Automated extraction from National Grid website (every 2 weeks)" }}
          {% else %}
            {{ "Manual input via Home Assistant input_number helpers" }}
          {% endif %}
        rates_update_instructions: >
          {{ "Rates automatically updated every 2 weeks from National Grid. Fallback: Update in Configuration > Helpers if needed" }}
        delivery_rate_schedule: >
          {{ "R-3C - Colonial Division (updates quarterly)" }}
        supply_rate_schedule: >
          {{ "Default Service (updates monthly)" }}
        rates_last_updated: >
          {% if states('sensor.national_grid_gas_delivery_rate') != 'unknown' and states('sensor.national_grid_gas_delivery_rate') != 'unavailable' %}
            {{ state_attr('sensor.national_grid_gas_delivery_rate', 'last_updated') | as_timestamp | timestamp_custom('%Y-%m-%d %H:%M:%S') if state_attr('sensor.national_grid_gas_delivery_rate', 'last_updated') else "Unknown" }}
          {% else %}
            {{ "Update manually from gas bill" }}
          {% endif %}

    # Calculate current month consumption trend
    - name: "Current Month Gas Consumption Trend"
      unique_id: current_month_gas_trend
      unit_of_measurement: "ft³"
      device_class: gas
      state_class: total_increasing
      state: >
        {% set current_total = states('sensor.gas_meter_consumption_15694770') | float(0) %}
        {% set current_month_start = state_attr('sensor.gas_utility', 'current_period') | float(0) %}
        {{ (current_total - current_month_start) | round(1) }}
      attributes:
        current_month_start: >
          {{ state_attr('sensor.gas_utility', 'current_period') | float(0) }}
        total_consumption: >
          {{ states('sensor.gas_meter_consumption_15694770') | float(0) }}
        days_in_month: >
          {{ now().day }}
        projected_monthly_consumption: >
          {% set current_consumption = states('sensor.current_month_gas_consumption_trend') | float(0) %}
          {% set days_elapsed = now().day %}
          {% set days_in_month = now().replace(day=28).replace(month=now().month+1) - now().replace(day=1) %}
          {% set total_days = days_in_month.days + 1 %}
          {{ (current_consumption * total_days / days_elapsed) | round(1) if days_elapsed > 0 else 0 }}

    # Monitor for rate changes from multiscrape sensors
    - name: "Gas Rate Change Monitor"
      unique_id: gas_rate_change_monitor
      state: >
        {% set delivery_rate = states('sensor.national_grid_gas_delivery_rate') | float(0) %}
        {% set supply_rate = states('sensor.national_grid_gas_supply_rate') | float(0) %}
        {% if delivery_rate > 0 and supply_rate > 0 %}
          {{ "Rates Active - Delivery: $" + delivery_rate|string + "/CCF, Supply: $" + supply_rate|string + "/CCF" }}
        {% else %}
          {{ "No rates available - Check multiscrape sensors" }}
        {% endif %}
      attributes:
        delivery_rate: >
          {{ states('sensor.national_grid_gas_delivery_rate') | float(0) }}
        supply_rate: >
          {{ states('sensor.national_grid_gas_supply_rate') | float(0) }}
        customer_charge: >
          {{ states('sensor.national_grid_gas_customer_charge') | float(0) }}
        rate_schedule: >
          {{ "R-3C - Residential Heating Colonial Division" }}
        rate_source: >
          {% set delivery_source = state_attr('sensor.national_grid_gas_delivery_rate', 'rate_source') | default('Unknown') %}
          {% set supply_source = state_attr('sensor.national_grid_gas_supply_rate', 'rate_source') | default('Unknown') %}
          {{ "Delivery: " + delivery_source + " | Supply: " + supply_source }}
        last_scraped: >
          {{ state_attr('sensor.national_grid_gas_delivery_rate', 'last_scraped') | default('Never') }}
        tariff_info: >
          {{ states('sensor.national_grid_gas_tariff_last_updated') | default('Check manually') }}
        automation_status: >
          {% set delivery_source = state_attr('sensor.national_grid_gas_delivery_rate', 'rate_source') | default('') %}
          {% set supply_source = state_attr('sensor.national_grid_gas_supply_rate', 'rate_source') | default('') %}
          {% if 'Extracted from National Grid website' in delivery_source or 'Extracted from National Grid website' in supply_source %}
            {{ "Fully automated - Rates extracted from National Grid website" }}
          {% else %}
            {{ "Using fallback rates - Manual updates may be needed" }}
          {% endif %}